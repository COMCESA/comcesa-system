<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>COMCESA | Sistema Corporativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    :root {
      --primary:#1f2937;
      --accent:#2563eb;
      --bg:#f3f4f6;
      --danger:#dc2626;
      --ok:#16a34a;
    }
    body {
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background:var(--bg);
    }
    .card {
      max-width:420px;
      margin:60px auto;
      background:#fff;
      padding:30px;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
    }
    h1,h2 {
      margin-top:0;
      text-align:center;
      color:var(--primary);
    }
    input, select, button {
      width:100%;
      padding:12px;
      margin-top:10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:15px;
    }
    button {
      background:var(--accent);
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:600;
    }
    button.secondary {
      background:#374151;
    }
    button.danger {
      background:var(--danger);
    }
    .hidden { display:none; }
    .msg {
      margin-top:12px;
      text-align:center;
      font-size:14px;
    }
    .ok { color:var(--ok); }
    .err { color:var(--danger); }
    .menu button {
      margin-top:12px;
    }
    small {
      display:block;
      text-align:center;
      color:#6b7280;
      margin-top:15px;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h1>COMCESA</h1>
  <input id="loginUser" placeholder="Usuario"/>
  <input id="loginCode" placeholder="C√≥digo Google Authenticator" />
  <button onclick="login()">Ingresar</button>
  <div class="msg" id="loginMsg"></div>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="dashCard">
  <h2 id="welcome"></h2>

  <div class="menu">
    <button onclick="mark('ENTRADA')">üü¢ Marcar Entrada</button>
    <button onclick="mark('SALIDA')" class="secondary">üîµ Marcar Salida</button>
    <button onclick="showVacation()">üìÖ Vacaciones</button>
    <button onclick="showIGSS()">üè• IGSS</button>
    <button onclick="showReport()" id="adminBtn" class="hidden">üìä Reporte Mensual</button>
    <button onclick="logout()" class="danger">Cerrar sesi√≥n</button>
  </div>

  <div class="msg" id="dashMsg"></div>
</div>

<!-- VACACIONES -->
<div class="card hidden" id="vacCard">
  <h2>Vacaciones</h2>
  <input type="date" id="vStart"/>
  <input type="date" id="vEnd"/>
  <select id="vType">
    <option>Vacaciones</option>
    <option>Permiso</option>
  </select>
  <input placeholder="Motivo" id="vReason"/>
  <button onclick="sendVacation()">Enviar</button>
  <button class="secondary" onclick="back()">Volver</button>
  <div class="msg" id="vacMsg"></div>
</div>

<!-- IGSS -->
<div class="card hidden" id="igssCard">
  <h2>IGSS</h2>
  <input type="date" id="iDate"/>
  <input type="time" id="iTime"/>
  <input placeholder="Tr√°mite" id="iTramite"/>
  <input placeholder="Lugar" id="iLugar"/>
  <input placeholder="Constancia" id="iConstancia"/>
  <input placeholder="Observaciones" id="iObs"/>
  <button onclick="sendIGSS()">Guardar</button>
  <button class="secondary" onclick="back()">Volver</button>
  <div class="msg" id="igssMsg"></div>
</div>

<!-- REPORT -->
<div class="card hidden" id="repCard">
  <h2>Reporte Mensual</h2>
  <input type="month" id="repMonth"/>
  <button onclick="getReport()">Generar</button>
  <pre id="repOut"></pre>
  <button class="secondary" onclick="back()">Volver</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz5ZdRd_BhEziOdvWPttsPmLB6b5HxpOW49ke15BTA2jUvAGwYeeoMIGOPR82uNp-DsiQ/exec";

let currentUser = null;

/* ------------------ HELPERS ------------------ */

function post(data){
  return fetch(API_URL,{
    method:'POST',
    body:JSON.stringify(data)
  }).then(r=>r.json());
}

function show(id){
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

/* ------------------ LOGIN ------------------ */

function login(){
  const username = loginUser.value.trim();
  const code = loginCode.value.trim();
  loginMsg.textContent = "Validando...";
  post({action:'login', username, code})
    .then(r=>{
      if(!r.success) throw "Credenciales inv√°lidas";
      currentUser = r.user;
      welcome.textContent = `Hola, ${r.user.nombre}`;
      if(r.user.rol === 'ADMIN') adminBtn.classList.remove('hidden');
      show('dashCard');
    })
    .catch(e=>{
      loginMsg.textContent = e;
      loginMsg.className = "msg err";
    });
}

/* ------------------ ASISTENCIA ------------------ */

function mark(tipo){
  dashMsg.textContent = "Procesando...";
  post({
    action:'attendance',
    username:currentUser.username,
    tipo,
    code:prompt("C√≥digo Authenticator")
  }).then(r=>{
    dashMsg.textContent = r.message || "Registrado";
    dashMsg.className = "msg ok";
  }).catch(()=>{
    dashMsg.textContent = "Error";
    dashMsg.className = "msg err";
  });
}

/* ------------------ VACACIONES ------------------ */

function showVacation(){ show('vacCard'); }
function sendVacation(){
  post({
    action:'vacation',
    username:currentUser.username,
    data:{
      start:vStart.value,
      end:vEnd.value,
      type:vType.value,
      reason:vReason.value
    }
  }).then(()=>{
    vacMsg.textContent = "Solicitud enviada";
    vacMsg.className = "msg ok";
  });
}

/* ------------------ IGSS ------------------ */

function showIGSS(){ show('igssCard'); }
function sendIGSS(){
  post({
    action:'igss',
    username:currentUser.username,
    data:{
      date:iDate.value,
      time:iTime.value,
      tramite:iTramite.value,
      lugar:iLugar.value,
      constancia:iConstancia.value,
      observaciones:iObs.value
    }
  }).then(()=>{
    igssMsg.textContent = "Registro guardado";
    igssMsg.className = "msg ok";
  });
}

/* ------------------ REPORTES ------------------ */

function showReport(){ show('repCard'); }
function getReport(){
  post({action:'adminReport', month:repMonth.value})
    .then(r=>{
      repOut.textContent = JSON.stringify(r.report,null,2);
    });
}

/* ------------------ NAV ------------------ */

function back(){ show('dashCard'); }
function logout(){
  currentUser=null;
  show('loginCard');
}
</script>

</body>
</html>
